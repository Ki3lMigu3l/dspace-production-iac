# roles/maven/tasks/main.yml (VERSÃO COM MÓDULOS ANSIBLE)
---
- name: Remove any existing broken Maven installation
  shell: |
    apt remove -y maven maven2 2>/dev/null || true
    rm -rf /opt/maven* /opt/apache-maven* 2>/dev/null || true
    rm -f /usr/local/bin/mvn /usr/bin/mvn 2>/dev/null || true
  become: true

- name: Download Maven {{ maven_version }}
  get_url:
    url: "https://archive.apache.org/dist/maven/maven-3/{{ maven_version }}/binaries/apache-maven-{{ maven_version }}-bin.tar.gz"
    dest: /tmp/apache-maven-{{ maven_version }}-bin.tar.gz
    mode: "0644"
  become: true

- name: Extract Maven to /opt
  unarchive:
    src: /tmp/apache-maven-{{ maven_version }}-bin.tar.gz
    dest: /opt
    remote_src: yes
    owner: root
    group: root
  become: true

- name: Create symlink /opt/maven
  file:
    src: "/opt/apache-maven-{{ maven_version }}"
    dest: /opt/maven
    state: link
  become: true

- name: Create symbolic links in PATH
  file:
    src: "/opt/maven/bin/mvn"
    dest: "{{ item }}"
    state: link
    force: yes
  with_items:
    - /usr/local/bin/mvn
    - /usr/bin/mvn
  become: true

- name: Install Ant
  apt:
    name: ant
    state: present
  become: true

- name: Verify Maven installation
  shell: |
    /opt/maven/bin/mvn --version
  register: maven_verify
  changed_when: false
  become: true

- name: Test Maven as dspace user
  shell: |
    sudo -u dspace /opt/maven/bin/mvn --version
  register: dspace_test
  changed_when: false
  become: true
