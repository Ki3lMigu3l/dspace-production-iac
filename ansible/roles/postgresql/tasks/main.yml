---
- name: Install PostgreSQL packages
  apt:
    name:
      - postgresql
      - postgresql-client
      - postgresql-contrib
      - libpostgresql-jdbc-java
    state: present
  become: true

- name: Get PostgreSQL version
  shell: psql --version | awk '{print $3}' | cut -d. -f1
  register: postgres_version
  changed_when: false

- name: Start and enable PostgreSQL service
  systemd:
    name: postgresql
    state: started
    enabled: true
  become: true

- name: Set password for postgres system user
  shell: echo "postgres:dspace" | chpasswd
  become: true

- name: Configure listen_addresses in postgresql.conf
  lineinfile:
    path: "/etc/postgresql/{{ postgres_version.stdout }}/main/postgresql.conf"
    regexp: '^#?listen_addresses\s*='
    line: "listen_addresses = 'localhost'"
  become: true

- name: Add DSpace configuration to pg_hba.conf
  lineinfile:
    path: "/etc/postgresql/{{ postgres_version.stdout }}/main/pg_hba.conf"
    insertbefore: "^# Database administrative login by Unix domain socket"
    line: "# DSpace configuration"
  become: true

- name: Add authentication rule for DSpace
  lineinfile:
    path: "/etc/postgresql/{{ postgres_version.stdout }}/main/pg_hba.conf"
    insertafter: "^# DSpace configuration"
    line: "host dspace dspace 127.0.0.1 255.255.255.255 md5"
  become: true

- name: Restart PostgreSQL service
  systemd:
    name: postgresql
    state: restarted
  become: true

- name: Create DSpace database user using sudo
  shell: |
    sudo -u postgres psql -c "CREATE USER dspace WITH PASSWORD 'dspace';" 2>/dev/null || sudo -u postgres psql -c "SELECT 'User dspace already exists';"
  become: true

- name: Create DSpace database using sudo
  shell: |
    sudo -u postgres psql -c "CREATE DATABASE dspace OWNER dspace ENCODING 'UTF8' TEMPLATE template0;" 2>/dev/null || sudo -u postgres psql -c "SELECT 'Database dspace already exists';"
  become: true

- name: Grant privileges to dspace user
  shell: |
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE dspace TO dspace;"
  become: true

- name: Test PostgreSQL connection for DSpace
  shell: |
    PGPASSWORD=dspace psql -h localhost -U dspace -d dspace -c "SELECT version();" 2>/dev/null || echo "Connection test failed or database not ready yet"
  register: postgres_test
  changed_when: false
  become: true

- name: Display PostgreSQL status
  debug:
    msg:
      - "PostgreSQL {{ postgres_version.stdout }} installed successfully"
      - "Database 'dspace' created"
      - "User 'dspace' created with password 'dspace'"
      - "Connection test: {{ 'Success' if 'PostgreSQL' in postgres_test.stdout else 'Pending' }}"
