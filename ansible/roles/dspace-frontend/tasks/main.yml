---
# tasks/main.yml - COM CARREGAMENTO DO NVM PARA PM2

- name: Corrigir pacotes quebrados
  shell: |
    apt-get clean
    apt-get autoremove -y
    apt-get install -f -y
    apt-get update
  become: true

- name: Instalar dependências básicas
  apt:
    name:
      - curl
      - wget
      - build-essential
    state: present
    update_cache: yes
  become: true

- name: Instalar NVM como root
  shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
    echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc
    echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bashrc
    echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> ~/.bashrc
  become: true
  args:
    creates: /root/.nvm/nvm.sh

- name: Instalar Node.js 20.19.4
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

    nvm install 20.19.4
    nvm use 20.19.4
    nvm alias default 20.19.4

    echo "Node.js: $(node --version)"
    echo "npm: $(npm --version)"
  become: true
  register: node_install

- name: Instalar Yarn e PM2 globalmente
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

    npm install --global yarn pm2

    # Verificar instalação
    echo "PM2 path: $(which pm2)"
    echo "PM2 versão: $(pm2 --version 2>/dev/null || echo 'instalando...')"
  become: true
  register: pm2_install

- name: Baixar DSpace Angular
  shell: |
    cd /home/dspace
    rm -rf dspace-angular-dspace-9.2 2>/dev/null || true

    wget -q https://github.com/DSpace/dspace-angular/archive/refs/tags/dspace-9.2.tar.gz
    tar zxvf dspace-9.2.tar.gz
    rm -f dspace-9.2.tar.gz

    chown -R dspace:dspace dspace-angular-dspace-9.2

    echo "DSpace Angular baixado"
  become: true

- name: Configurar arquivos de configuração
  shell: |
    sudo -u dspace bash -c '
    cd /home/dspace/dspace-angular-dspace-9.2/config

    cp config.example.yml config.prod.yml

    sed -i "/^rest:/,/^[^[:space:]]/ {
      s/ssl: true/ssl: false/
      s/host:.*/host: localhost/
      s/port:.*/port: 8080/
    }" config.prod.yml

    echo "Config REST:"
    grep -A 3 "^rest:" config.prod.yml
    '
  become: true

- name: Instalar dependências do DSpace
  shell: |
    sudo -u dspace bash -c '
    cd /home/dspace/dspace-angular-dspace-9.2

    export PATH="/root/.nvm/versions/node/v20.19.4/bin:$PATH"

    echo "Instalando dependências..."
    npm install --legacy-peer-deps

    echo "Dependências instaladas"
    '
  become: true

- name: Adicionar @popperjs/core
  shell: |
    sudo -u dspace bash -c '
    cd /home/dspace/dspace-angular-dspace-9.2

    export PATH="/root/.nvm/versions/node/v20.19.4/bin:$PATH"

    npm add @popperjs/core
    echo "@popperjs/core instalado"
    '
  become: true

- name: Compilar DSpace Angular
  shell: |
    sudo -u dspace bash -c '
    cd /home/dspace/dspace-angular-dspace-9.2

    export PATH="/root/.nvm/versions/node/v20.19.4/bin:$PATH"
    export NODE_TLS_REJECT_UNAUTHORIZED="0"
    export NODE_OPTIONS="--max-old-space-size=8192"

    echo "Compilando..."
    echo "Node: $(node --version)"

    rm -rf dist 2>/dev/null || true

    npm run build:prod

    if [ -d "dist" ]; then
      echo "✅ Build criado"
      ls -la dist/
      exit 0
    else
      echo "❌ Build falhou"
      exit 1
    fi
    '
  become: true
  register: build_result
  ignore_errors: true

- name: Verificar se build foi criado
  stat:
    path: "{{ item }}"
  with_items:
    - /home/dspace/dspace-angular-dspace-9.2/dist
    - /home/dspace/dspace-angular-dspace-9.2/dist/server/main.js
  register: build_check
  become: true

- name: Criar configuração do PM2
  shell: |
    sudo -u dspace bash -c '
    cd /home/dspace/dspace-angular-dspace-9.2

    cat > dspace-ui.json << "EOF"
    {
        "apps": [
            {
               "name": "dspace-ui",
               "cwd": "/home/dspace/dspace-angular-dspace-9.2/",
               "script": "dist/server/main.js",
               "instances": 1,
               "exec_mode": "fork",
               "env": {
                  "NODE_ENV": "production",
                  "NODE_TLS_REJECT_UNAUTHORIZED": "0",
                  "NODE_OPTIONS": "--max-old-space-size=2048"
               }
            }
        ]
    }
    EOF

    echo "Config PM2 criada"
    '
  become: true
  when: build_check.results[0].stat.exists

- name: Iniciar serviço com PM2 (carregando NVM)
  shell: |
    # Carregar NVM primeiro
    export NVM_DIR="/root/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

    cd /home/dspace/dspace-angular-dspace-9.2

    # Verificar se PM2 está disponível
    echo "PM2 path: $(which pm2)"
    echo "Node path: $(which node)"

    # Parar se existir
    pm2 delete dspace-ui 2>/dev/null || true
    sleep 2

    # Iniciar
    pm2 start dspace-ui.json
    pm2 save

    # Configurar startup
    pm2 startup 2>/dev/null || echo "Startup já configurado"

    echo "✅ PM2 iniciado"
    echo ""
    pm2 list
  become: true
  when: build_check.results[0].stat.exists
  register: pm2_start

- name: Testar serviço
  shell: |
    sleep 5

    for i in {1..3}; do
      echo "Teste $i..."
      if timeout 3 curl -s http://localhost:4000 > /dev/null 2>&1; then
        echo "✅ SERVIÇO RESPONDE"
        exit 0
      fi
      sleep 2
    done

    echo "⚠️ Serviço não responde"

    # Diagnóstico
    echo "Processos Node:"
    ps aux | grep -E "(node|pm2)" | grep -v grep || echo "Nenhum"

    echo "Porta 4000:"
    ss -tlnp | grep :4000 || netstat -tlnp 2>/dev/null | grep :4000 || echo "Não em uso"

    exit 1
  become: true
  register: service_test
  ignore_errors: true
  when: build_check.results[0].stat.exists

- name: Relatório final
  debug:
    msg: |
      ========================================
      INSTALAÇÃO DSPACE ANGULAR
      ========================================

      STATUS:
      - Node.js: {{ node_install.stdout_lines[-2] if node_install.stdout_lines else '20.19.4' }}
      - PM2: {{ '✅ INSTALADO' if pm2_install is succeeded else '❌ FALHOU' }}
      - Build: {{ '✅ CRIADO' if build_check.results[0].stat.exists else '❌ FALHOU' }}

      {% if build_check.results[0].stat.exists %}
      SERVIÇO:
      - PM2: {{ '✅ INICIADO' if pm2_start is defined else '❌ NÃO' }}
      - Status: {{ '✅ ONLINE' if service_test.rc == 0 else '⚠️ PROBLEMAS' }}
      - Porta: 4000

      ACESSO:
      - DSpace: http://{{ ansible_host }}:4000
      - API: http://{{ ansible_host }}:8080

      COMANDOS:
      sudo pm2 list
      sudo pm2 logs dspace-ui
      sudo pm2 restart dspace-ui

      {% if service_test.rc != 0 %}
      PROBLEMAS:
      Serviço não responde.

      Solução:
      1. ssh usuario@{{ ansible_host }}
      2. sudo pm2 logs dspace-ui
      3. sudo pm2 restart dspace-ui
      4. curl http://localhost:4000
      {% endif %}

      {% else %}
      FALHA NA COMPILAÇÃO

      SOLUÇÃO MANUAL:

      1. Conecte: ssh usuario@{{ ansible_host }}
      2. Execute: sudo su
      3. Tente:
         cd /home/dspace/dspace-angular-dspace-9.2
         export NODE_TLS_REJECT_UNAUTHORIZED="0"
         export NODE_OPTIONS="--max-old-space-size=8192"
         sudo -u dspace npm run build:prod

      4. Se falhar, tente Node.js 18:
         nvm install 18
         nvm use 18
         sudo -u dspace npm run build:prod
      {% endif %}
      ========================================
